#!/usr/bin/env bash
set -euo pipefail

echo "üß™ Testando instala√ß√£o do Piper TTS..."

# Verifica se estamos testando uma instala√ß√£o local
if [ -f "./test-install/bin/piper" ]; then
    PIPER_CMD="./test-install/bin/piper"
    PIPER_LIST_CMD="./test-install/bin/piper-list-models"
    VENV_PATH="./test-install/venv"
    echo "‚úÖ Detectada instala√ß√£o local em ./test-install/"
else
    # Verifica se o comando piper est√° dispon√≠vel
    if ! command -v piper &> /dev/null; then
        echo "‚ùå Comando 'piper' n√£o encontrado"
        exit 1
    fi
    PIPER_CMD="piper"
    PIPER_LIST_CMD="piper-list-models"
    VENV_PATH="$(dirname "$(which piper)")/../venv"
fi

echo "‚úÖ Comando 'piper' encontrado: $PIPER_CMD"

# Verifica se o comando piper-list-models est√° dispon√≠vel
if ! command -v "$PIPER_LIST_CMD" &> /dev/null; then
    echo "‚ùå Comando 'piper-list-models' n√£o encontrado"
    exit 1
fi

echo "‚úÖ Comando 'piper-list-models' encontrado"

# Testa a ajuda do piper
if ! "$PIPER_CMD" --help &> /dev/null; then
    echo "‚ùå Erro ao executar '$PIPER_CMD --help'"
    exit 1
fi

echo "‚úÖ Comando '$PIPER_CMD --help' executado com sucesso"

# Testa a listagem de modelos
if ! "$PIPER_LIST_CMD" &> /dev/null; then
    echo "‚ùå Erro ao executar '$PIPER_LIST_CMD'"
    exit 1
fi

echo "‚úÖ Comando '$PIPER_LIST_CMD' executado com sucesso"

# Verifica se o ambiente virtual Python existe
if [ ! -d "$VENV_PATH" ]; then
    echo "‚ùå Ambiente virtual Python n√£o encontrado em $VENV_PATH"
    exit 1
fi

echo "‚úÖ Ambiente virtual Python encontrado"

# Verifica se o piper-tts est√° instalado no ambiente virtual
if ! "$VENV_PATH/bin/python" -c "import piper" 2>/dev/null; then
    echo "‚ùå M√≥dulo 'piper' n√£o encontrado no ambiente virtual"
    exit 1
fi

echo "‚úÖ M√≥dulo 'piper' encontrado no ambiente virtual"

# Verifica se o diret√≥rio de modelos existe
MODEL_DIR="${HOME}/.local/share/mise/piper-models"
if [ ! -d "$MODEL_DIR" ]; then
    echo "‚ö†Ô∏è  Diret√≥rio de modelos n√£o existe: $MODEL_DIR"
    echo "   Execute '$PIPER_LIST_CMD' para ver modelos dispon√≠veis"
else
    echo "‚úÖ Diret√≥rio de modelos encontrado: $MODEL_DIR"
fi

echo ""
echo "üéâ Todos os testes passaram! O Piper TTS est√° funcionando corretamente."
echo ""
echo "üìù Pr√≥ximos passos:"
echo "   1. Execute '$PIPER_LIST_CMD' para ver modelos dispon√≠veis"
echo "   2. Execute '$PIPER_CMD --download-model pt_BR faber' para baixar voz em portugu√™s"
echo "   3. Teste com: echo 'Ol√°, Alice, esse √© um teste de voz usando pontua√ß√£o e n√∫meros de 1,00 real at√©  5,00 reais' | $PIPER_CMD --model ~/.local/share/mise/piper-models/pt_BR/voice.onnx --output_file teste.wav"
