#!/usr/bin/env bash
set -euo pipefail

# Vari√°veis do plugin
PACKAGE_NAME="piper-tts"
VERSION="latest"

# Path de instala√ß√£o fornecido pelo asdf/mise
INSTALL_PATH="${ASDF_INSTALL_PATH:-${1:-}}"
if [ -z "$INSTALL_PATH" ]; then
  echo ">>> ERRO: nenhum path de instala√ß√£o fornecido"
  exit 1
fi

echo ">>> Instalando Piper TTS em $INSTALL_PATH"

# Cria diret√≥rios
mkdir -p "$INSTALL_PATH/bin"
mkdir -p "$INSTALL_PATH/lib"

# Detecta a vers√£o se for latest
if [ "$VERSION" = "latest" ]; then
    VERSION=$(curl -s "https://pypi.org/pypi/$PACKAGE_NAME/json" | jq -r '.info.version')
    echo ">>> √öltima vers√£o detectada: $VERSION"
fi

# Cria ambiente virtual Python
echo ">>> Criando ambiente virtual Python..."
python3 -m venv "$INSTALL_PATH/venv"

# Ativa o ambiente virtual
source "$INSTALL_PATH/venv/bin/activate"

# Atualiza pip
echo ">>> Atualizando pip..."
pip install --upgrade pip

# Instala o Piper TTS e depend√™ncias para treinamento
echo ">>> Instalando Piper TTS $VERSION..."
pip install "$PACKAGE_NAME==$VERSION"

# Instala depend√™ncias adicionais para treinamento
echo ">>> Instalando depend√™ncias para treinamento..."
pip install torch torchaudio transformers datasets

# Fun√ß√£o para detectar o diret√≥rio de modelos baseado no gerenciador usado
get_model_dir() {
    # Detecta se est√° usando asdf ou mise
    if [ -n "${ASDF_DATA_DIR:-}" ]; then
        # Usando asdf
        echo "${ASDF_DATA_DIR}/piper-models"
    elif [ -n "${MISE_DATA_DIR:-}" ]; then
        # Usando mise
        echo "${MISE_DATA_DIR}/piper-models"
    else
        # Fallback para diret√≥rio padr√£o
        echo "${HOME}/.local/share/piper-models"
    fi
}

# Cria o wrapper principal
cat > "$INSTALL_PATH/bin/piper" << 'EOF'
#!/usr/bin/env bash
set -euo pipefail

# Path do ambiente virtual
VENV_PATH="$(dirname "$0")/../venv"

# Fun√ß√£o para detectar o diret√≥rio de modelos baseado no gerenciador usado
get_model_dir() {
    # Detecta se est√° usando asdf ou mise
    if [ -n "${ASDF_DATA_DIR:-}" ]; then
        # Usando asdf
        echo "${ASDF_DATA_DIR}/piper-models"
    elif [ -n "${MISE_DATA_DIR:-}" ]; then
        # Usando mise
        echo "${MISE_DATA_DIR}/piper-models"
    else
        # Fallback para diret√≥rio padr√£o
        echo "${HOME}/.local/share/piper-models"
    fi
}

MODEL_DIR=$(get_model_dir)
mkdir -p "$MODEL_DIR"

# Fun√ß√£o para baixar modelo
download_model() {
    local model_name="$1"
    local voice_name="$2"
    
    echo "Baixando modelo $model_name/$voice_name..."
    
    # Cria diret√≥rio para o modelo espec√≠fico
    mkdir -p "${MODEL_DIR}/${model_name}/${voice_name}"
    
    # URLs dos modelos (modelos que realmente existem)
    case "$model_name" in
        "pt_BR")
            case "$voice_name" in
                "cadu")
                    MODEL_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/cadu/medium/pt_BR-cadu-medium.onnx.json"
                    VOICE_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/cadu/medium/pt_BR-cadu-medium.onnx"
                    ;;
                "edresson")
                    MODEL_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/edresson/medium/pt_BR-edresson-medium.onnx.json"
                    VOICE_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/edresson/medium/pt_BR-edresson-medium.onnx"
                    ;;
                "faber")
                    MODEL_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/faber/medium/pt_BR-faber-medium.onnx.json"
                    VOICE_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/faber/medium/pt_BR-faber-medium.onnx"
                    ;;
                "jeff")
                    MODEL_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/jeff/medium/pt_BR-jeff-medium.onnx.json"
                    VOICE_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/pt/pt_BR/jeff/medium/pt_BR-jeff-medium.onnx"
                    ;;
                *)
                    echo "Voz $voice_name n√£o encontrada para pt_BR"
                    echo "Vozes dispon√≠veis: cadu, edresson, faber, jeff"
                    exit 1
                    ;;
            esac
            ;;
        "en_US")
            case "$voice_name" in
                "amy")
                    MODEL_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/en/us/amy/medium/voice.json"
                    VOICE_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/en/us/amy/medium/voice.onnx"
                    ;;
                "jenny")
                    MODEL_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/en/us/jenny/medium/voice.json"
                    VOICE_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/en/us/jenny/medium/voice.onnx"
                    ;;
                *)
                    echo "Voz $voice_name n√£o encontrada para en_US"
                    echo "Vozes dispon√≠veis: amy, jenny"
                    exit 1
                    ;;
            esac
            ;;
        *)
            echo "Modelo $model_name n√£o suportado"
            echo "Modelos dispon√≠veis: pt_BR, en_US"
            exit 1
            ;;
    esac
    
    # Baixa os arquivos
    echo "Baixando voice.json..."
    curl -L -o "${MODEL_DIR}/${model_name}/${voice_name}/voice.json" "$MODEL_URL"
    echo "Baixando voice.onnx..."
    curl -L -o "${MODEL_DIR}/${model_name}/${voice_name}/voice.onnx" "$VOICE_URL"
    
    # Copia o arquivo JSON com o nome que o Piper espera
    cp "${MODEL_DIR}/${model_name}/${voice_name}/voice.json" "${MODEL_DIR}/${model_name}/${voice_name}/voice.onnx.json"
    
    echo "Modelo $model_name/$voice_name baixado com sucesso!"
    echo "Diret√≥rio: ${MODEL_DIR}/${model_name}/${voice_name}/"
}

# Fun√ß√£o para criar dataset de treinamento
create_training_dataset() {
    local model_name="$1"
    local voice_name="$2"
    
    echo "Criando dataset de treinamento para $model_name/$voice_name..."
    
    # Cria diret√≥rio para o dataset
    mkdir -p "${MODEL_DIR}/${model_name}/${voice_name}/training_data"
    
    # Cria arquivo com exemplos de texto brasileiro
    cat > "${MODEL_DIR}/${model_name}/${voice_name}/training_data/brazilian_texts.txt" << 'BRAZILIAN_TEXTS'
# Dataset de treinamento para melhorar pron√∫ncia brasileira
# Formato: texto|arquivo_audio.wav

# S√≠mbolos monet√°rios
R$ 1,00|money_1_real.wav
R$ 5,00|money_5_reais.wav
R$ 10,50|money_10_50.wav
R$ 25,75|money_25_75.wav
R$ 100,00|money_100_reais.wav

# Porcentagens
10%|percent_10.wav
25%|percent_25.wav
50%|percent_50.wav
100%|percent_100.wav

# Opera√ß√µes matem√°ticas
2+3=5|math_2_plus_3.wav
10-5=5|math_10_minus_5.wav
4*6=24|math_4_times_6.wav
15/3=5|math_15_divided_by_3.wav

# N√∫meros com v√≠rgula decimal
1,5|decimal_1_5.wav
2,75|decimal_2_75.wav
10,25|decimal_10_25.wav

# Textos comuns brasileiros
Ol√°, tudo bem?|greeting.wav
Bom dia!|good_morning.wav
Boa tarde!|good_afternoon.wav
Boa noite!|good_night.wav
Obrigado!|thank_you.wav
Por favor!|please.wav
BRAZILIAN_TEXTS

    echo "Dataset criado em ${MODEL_DIR}/${model_name}/${voice_name}/training_data/"
    echo "Para treinar o modelo, voc√™ precisar√°:"
    echo "1. Gravar √°udios correspondentes aos textos"
    echo "2. Usar o script de fine-tuning: piper-train-finetune"
}

# Fun√ß√£o para fine-tuning do modelo
finetune_model() {
    local model_name="$1"
    local voice_name="$2"
    
    echo "Iniciando fine-tuning do modelo $model_name/$voice_name..."
    
    # Verifica se o dataset existe
    if [ ! -f "${MODEL_DIR}/${model_name}/${voice_name}/training_data/brazilian_texts.txt" ]; then
        echo "Dataset n√£o encontrado. Execute primeiro:"
        echo "piper --create-dataset $model_name $voice_name"
        exit 1
    fi
    
    # Ativa o ambiente virtual
    source "$VENV_PATH/bin/activate"
    
    # Executa o fine-tuning (exemplo b√°sico)
    echo "Executando fine-tuning..."
    echo "Nota: Esta √© uma implementa√ß√£o b√°sica. Para fine-tuning completo,"
    echo "consulte a documenta√ß√£o do Piper TTS."
    
    # Aqui voc√™ implementaria o c√≥digo de fine-tuning real
    # Por enquanto, apenas informa sobre o processo
    echo "Fine-tuning iniciado para melhorar pron√∫ncia brasileira."
}

# Fun√ß√£o para resolver nome de modelo para path completo
resolve_model_path() {
    local model_arg="$1"
    
    # Se j√° √© um path completo, retorna como est√°
    if [[ "$model_arg" == /* ]] || [[ "$model_arg" == ./* ]] || [[ "$model_arg" == ../* ]]; then
        echo "$model_arg"
        return
    fi
    
    # Se cont√©m /, assume que √© modelo/voz
    if [[ "$model_arg" == */* ]]; then
        local model_name="${model_arg%/*}"
        local voice_name="${model_arg#*/}"
        echo "${MODEL_DIR}/${model_name}/${voice_name}/voice.onnx"
        return
    fi
    
    # Se √© apenas um nome, procura em pt_BR primeiro, depois en_US
    if [ -f "${MODEL_DIR}/pt_BR/${model_arg}/voice.onnx" ]; then
        echo "${MODEL_DIR}/pt_BR/${model_arg}/voice.onnx"
    elif [ -f "${MODEL_DIR}/en_US/${model_arg}/voice.onnx" ]; then
        echo "${MODEL_DIR}/en_US/${model_arg}/voice.onnx"
    else
        echo "Modelo '$model_arg' n√£o encontrado. Use 'piper-list-models' para ver modelos dispon√≠veis."
        exit 1
    fi
}

# Ativa o ambiente virtual
source "$VENV_PATH/bin/activate"

# Array para armazenar argumentos do piper
ARGS=()
INPUT_TEXT=""

# Processa argumentos especiais
while [[ $# -gt 0 ]]; do
    case "$1" in
        --download-model)
            if [[ $# -lt 3 ]]; then
                echo "ERRO: '--download-model' requer dois argumentos: <modelo> <voz>"
                exit 1
            fi
            download_model "$2" "$3"
            shift 3
            exit 0
            ;;
        --create-dataset)
            if [[ $# -lt 3 ]]; then
                echo "ERRO: '--create-dataset' requer dois argumentos: <modelo> <voz>"
                exit 1
            fi
            create_training_dataset "$2" "$3"
            shift 3
            exit 0
            ;;
        --finetune)
            if [[ $# -lt 3 ]]; then
                echo "ERRO: '--finetune' requer dois argumentos: <modelo> <voz>"
                exit 1
            fi
            finetune_model "$2" "$3"
            shift 3
            exit 0
            ;;
        --model-dir)
            if [[ $# -lt 2 ]]; then
                echo "ERRO: '--model-dir' requer um argumento"
                exit 1
            fi
            MODEL_DIR="$2"
            ARGS+=("--model" "$MODEL_DIR")
            shift 2
            ;;

        -m|--model)
            if [[ $# -lt 2 ]]; then
                echo "ERRO: '-m/--model' requer um argumento"
                exit 1
            fi
            # Resolve o nome do modelo para path completo
            MODEL_PATH=$(resolve_model_path "$2")
            ARGS+=("--model" "$MODEL_PATH")
            shift 2
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

# Se h√° texto na entrada padr√£o, processa-o
if [ -t 0 ]; then
    # N√£o h√° entrada padr√£o, executa normalmente
    if [[ ${#ARGS[@]} -eq 0 ]]; then
        # Se n√£o h√° argumentos, mostra ajuda
        echo "Piper TTS - Plugin ASDF/Mise"
        echo ""
        echo "Uso:"
        echo "  piper --download-model <modelo> <voz>     # Baixar modelo"
        echo "  piper --create-dataset <modelo> <voz>     # Criar dataset de treinamento"
        echo "  piper --finetune <modelo> <voz>           # Fine-tuning do modelo"
        echo "  piper --help                              # Ajuda do Piper TTS"
        echo ""
        echo "Exemplos:"
        echo "  piper --download-model pt_BR faber"
        echo "  echo 'Ol√°, mundo!' | piper -m faber --output_file teste.wav"
        echo "  echo 'Hello, world!' | piper -m amy --output_file teste.wav"
        echo ""
        echo "Modelos dispon√≠veis:"
        echo "  pt_BR: cadu, edresson, faber, jeff"
        echo "  en_US: amy, jenny"
        echo ""
        echo "Use 'piper-list-models' para ver modelos dispon√≠veis"
        echo "Use 'piper-train-finetune' para informa√ß√µes sobre treinamento"
        exit 0
    else
        exec python -m piper "${ARGS[@]}"
    fi
else
    # H√° entrada padr√£o, executa diretamente
    python -m piper "${ARGS[@]}"
fi
EOF

chmod +x "$INSTALL_PATH/bin/piper"

# Cria script auxiliar para listar modelos dispon√≠veis
cat > "$INSTALL_PATH/bin/piper-list-models" << 'EOF'
#!/usr/bin/env bash
set -euo pipefail

# Fun√ß√£o para detectar o diret√≥rio de modelos baseado no gerenciador usado
get_model_dir() {
    # Detecta se est√° usando asdf ou mise
    if [ -n "${ASDF_DATA_DIR:-}" ]; then
        # Usando asdf
        echo "${ASDF_DATA_DIR}/piper-models"
    elif [ -n "${MISE_DATA_DIR:-}" ]; then
        # Usando mise
        echo "${MISE_DATA_DIR}/piper-models"
    else
        # Fallback para diret√≥rio padr√£o
        echo "${HOME}/.local/share/piper-models"
    fi
}

MODEL_DIR=$(get_model_dir)

echo "Modelos dispon√≠veis para download:"
echo ""
echo "Portugu√™s Brasileiro (pt_BR):"
echo "  - cadu (masculina) - voz brasileira nativa"
echo "  - edresson (masculina) - voz brasileira nativa"
echo "  - faber (masculina) - voz brasileira nativa"
echo "  - jeff (masculina) - voz brasileira nativa"
echo ""
echo "Ingl√™s Americano (en_US):"
echo "  - amy (feminina)"
echo "  - jenny (feminina)"
echo ""
echo "Para baixar um modelo:"
echo "  piper --download-model pt_BR cadu"
echo "  piper --download-model pt_BR edresson"
echo "  piper --download-model pt_BR faber"
echo "  piper --download-model pt_BR jeff"
echo "  piper --download-model en_US amy"
echo ""
echo "Para melhorar a pron√∫ncia brasileira:"
echo "  1. piper --create-dataset pt_BR faber"
echo "  2. Grave √°udios correspondentes aos textos"
echo "  3. piper --finetune pt_BR faber"
echo ""
echo "Nota: Todas as vozes brasileiras s√£o nativas de alta qualidade."
echo "      Fonte: https://huggingface.co/rhasspy/piper-voices/tree/main/pt/pt_BR"
echo ""
echo "Exemplo de uso:"
echo "  echo 'Ol√°, mundo!' | piper -m faber --output_file teste.wav"
echo "  echo 'Hello, world!' | piper -m amy --output_file teste.wav"
echo ""
echo "üí° Dica: Para melhor qualidade, considere treinar o modelo com dados brasileiros!"
echo ""
echo "Diret√≥rio de modelos: $MODEL_DIR"
EOF

chmod +x "$INSTALL_PATH/bin/piper-list-models"

# Cria script para fine-tuning avan√ßado
cat > "$INSTALL_PATH/bin/piper-train-finetune" << 'EOF'
#!/usr/bin/env bash
set -euo pipefail

echo "üéØ Piper TTS - Fine-tuning para Melhorar Pron√∫ncia Brasileira"
echo ""

# Verifica se o ambiente virtual est√° ativo
if [ -z "${VIRTUAL_ENV:-}" ]; then
    echo "‚ùå Ambiente virtual n√£o ativo"
    exit 1
fi

echo "‚úÖ Ambiente virtual ativo: $VIRTUAL_ENV"
echo ""

echo "üìã Passos para Fine-tuning:"
echo ""
echo "1. üìù Preparar dados de treinamento:"
echo "   - Textos com s√≠mbolos monet√°rios (R$ 1,00)"
echo "   - √Åudios correspondentes gravados por falante nativo"
echo "   - Formato: texto|arquivo_audio.wav"
echo ""
echo "2. üîß Configurar ambiente:"
echo "   - Instalar depend√™ncias de treinamento"
echo "   - Preparar scripts de fine-tuning"
echo ""
echo "3. üéØ Executar fine-tuning:"
echo "   - Treinar modelo com dados brasileiros"
echo "   - Validar resultados"
echo ""
echo "4. üì¶ Exportar modelo melhorado:"
echo "   - Converter para formato ONNX"
echo "   - Testar pron√∫ncia"
echo ""
echo "üìö Recursos para Fine-tuning:"
echo "   - Documenta√ß√£o Piper: https://github.com/rhasspy/piper"
echo "   - Coqui TTS: https://github.com/coqui-ai/TTS"
echo "   - Hugging Face: https://huggingface.co/rhasspy/piper"
echo ""
echo "üí° Dica: Para resultados √≥timos, use pelo menos 100 exemplos de √°udio"
echo "         com s√≠mbolos monet√°rios e n√∫meros brasileiros."
EOF

chmod +x "$INSTALL_PATH/bin/piper-train-finetune"

echo ">>> Instala√ß√£o conclu√≠da!"
echo ">>> Use 'piper --help' para ver as op√ß√µes dispon√≠veis"
echo ">>> Use 'piper-list-models' para ver modelos dispon√≠veis"
echo ">>> Use 'piper-train-finetune' para informa√ß√µes sobre treinamento"
